<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ecommind – Assistant premium</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1220;--panel:#0f1a2b;--muted:#8aa0c6;--text:#eaf1ff;
      --brand:#00BFFF;--gold:#C9A55E;--ok:#2ecc71;--err:#ff6b6b;
      --card:#0d1526;--card2:#101b31;--hl:#17223a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 600px at 10% -10%, #13213a 0%, transparent 60%) , radial-gradient(900px 600px at 110% -20%, #1a1140 0%, transparent 60%) , var(--bg);
      color:var(--text); font:500 16px/1.6 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;
    }
    .brand{display:flex;gap:14px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:conic-gradient(from 200deg, var(--gold), var(--brand), #7d58ff, var(--gold));
      filter:drop-shadow(0 10px 30px rgba(0,191,255,.25));
    }
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .tag{font-size:12px;color:var(--muted)}
    .pill{
      border:1px solid #1f2b45;background:linear-gradient(180deg,#0f1930,#0c162a);
      padding:9px 12px;border-radius:999px;display:flex;align-items:center;gap:8px;color:var(--muted)
    }
    .ok{color:var(--ok)} .bad{color:var(--err)}
    .hero{
      border:1px solid #1e2a45;background:linear-gradient(180deg,var(--panel),#0b1426 60%);
      border-radius:var(--radius); padding:24px; overflow:hidden; position:relative;
      box-shadow:inset 0 0 0 1px #0e1a31, 0 20px 60px rgba(0,0,0,.35);
    }
    .grid{display:grid;gap:14px;grid-template-columns:1.3fr .7fr}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .title{
      font-size:38px; line-height:1.15; font-weight:800; margin:0 0 8px;
    }
    .title .a{color:var(--brand)} .title .b{color:var(--gold)}
    .sub{color:var(--muted);margin:0 0 18px}
    .panel{
      border:1px solid #1b2741;background:linear-gradient(180deg,var(--card),var(--card2));
      border-radius:16px;padding:16px
    }
    .row{display:flex;gap:10px;align-items:center}
    .input{
      flex:1;border:1px solid #223152;background:#0e1930;border-radius:14px;padding:12px 14px;color:var(--text);
      outline:none; box-shadow:0 0 0 2px transparent; transition:.15s;
    }
    .input:focus{box-shadow:0 0 0 2px rgba(0,191,255,.35)}
    .btn{
      background:linear-gradient(180deg,#0e2b4a,#0a223d);color:var(--text);
      border:1px solid #1e395a; padding:11px 14px;border-radius:12px;cursor:pointer;
      transition:.15s; font-weight:700; letter-spacing:.2px;
    }
    .btn:hover{transform:translateY(-1px)}
    .muted{color:var(--muted);font-size:13px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .card{border:1px solid #1b2741;background:linear-gradient(180deg,#0e1830,#0a1328);border-radius:14px;padding:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px}
    .bubble{
      background:#0f1930;border:1px solid #1e2a45;border-radius:12px;padding:10px 12px;margin:8px 0
    }
    .me{border-color:#24466b;background:#10243f}
    .ai{border-color:#513c7a;background:#111636}
    .watermark{position:absolute;inset:auto -20px -20px auto;width:280px;height:280px;border-radius:50%;
      background:radial-gradient(closest-side, rgba(0,191,255,.5), transparent 70%); filter:blur(20px); opacity:.25; pointer-events:none}
    .switch{display:flex;gap:6px;align-items:center}
    .switch input{appearance:none;width:40px;height:22px;background:#13243e;border-radius:12px;position:relative;outline:none;border:1px solid #1e395a;cursor:pointer}
    .switch input:after{content:"";position:absolute;inset:3px auto auto 3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.15s}
    .switch input:checked{background:#13354e}
    .switch input:checked:after{left:21px;background:#9fe3ff}
    footer{display:flex;justify-content:space-between;align-items:center;margin-top:16px;color:var(--muted);font-size:12px}
    .link{color:var(--brand);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ecommind – <span class="tag">Assistant IA</span></h1>
          <div class="tag">Captiver. Déclencher. <b>Convertir.</b></div>
        </div>
      </div>
      <div class="pill" id="env-pill">Chargement de l’environnement…</div>
    </header>

    <section class="hero">
      <div class="grid">
        <div>
          <h2 class="title">
            Votre assistant <span class="a">multilingue</span> qui parle, comprend et
            <span class="b">close</span> sans friction.
          </h2>
          <p class="sub">Voix naturelle. Détection automatique de langue. Réponses courtes orientées décision. Démarrage instantané — pas de clic.</p>

          <div class="panel">
            <div class="row" style="gap:12px;align-items:flex-start">
              <input id="msg" class="input" autocomplete="off" placeholder="Écrivez un message (Entrée pour envoyer)…">
              <button id="sendBtn" class="btn">Envoyer</button>
              <label class="switch" title="Muet / Parler">
                <input id="muteToggle" type="checkbox" />
                <span class="muted">Muet</span>
              </label>
            </div>
            <div id="status" class="muted" style="margin-top:8px">Initialisation de la voix…</div>

            <div id="thread" style="margin-top:10px;max-height:260px;overflow:auto"></div>

            <div class="kpis">
              <div class="card">
                <div class="muted">Langue détectée</div>
                <div id="langBadge" class="mono">—</div>
              </div>
              <div class="card">
                <div class="muted">Lecture audio</div>
                <div class="mono" id="playBadge">-</div>
              </div>
              <div class="card">
                <div class="muted">LLM</div>
                <div class="mono" id="llmBadge">gpt-4o-mini</div>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="muted">Ce que fait l’assistant</div>
          <div class="bubble ai">Présenter votre offre avec un ton premium et rassurant.</div>
          <div class="bubble ai">Répondre aux questions en une phrase claire + proposition de créneau.</div>
          <div class="bubble ai">Basculer automatiquement dans la langue du prospect.</div>
          <div class="bubble ai">Éviter tout chevauchement vocal (lecture file d’attente).</div>
          <div class="bubble ai">Proposer le <b>next-step</b> discret (WhatsApp / RDV).</div>
        </div>
      </div>

      <div class="watermark"></div>
    </section>

    <footer>
      <div>© Ecommind Agency — <span class="muted">Design CAC40, sans blabla.</span></div>
      <a class="link" href="#" onclick="VC.speak('Bienvenue dans la démonstration Ecommind. Posez votre question.', 'fr');return false;">Relancer l’accueil</a>
    </footer>
  </div>

  <script>
    // ========= CONFIG ENDPOINTS (Netlify) =========
    const FN = (name) => `/.netlify/functions/${name}`;

    // ========= UTIL =========
    const $ = (sel)=>document.querySelector(sel);
    const thread = $("#thread");
    const statusEl = $("#status");
    const langBadge = $("#langBadge");
    const playBadge = $("#playBadge");
    const envPill = $("#env-pill");
    const llmBadge = $("#llmBadge");
    const muteToggle = $("#muteToggle");

    const UI = {
      push(role, text){
        const div = document.createElement("div");
        div.className = "bubble " + (role === "user" ? "me":"ai");
        div.textContent = text;
        thread.appendChild(div);
        thread.scrollTop = thread.scrollHeight;
      },
      setStatus(t){ statusEl.textContent = t; },
      setLang(l){ langBadge.textContent = l || "—"; },
      setPlay(t){ playBadge.textContent = t || "-"; },
      setEnv(ok){
        envPill.innerHTML = ok
          ? `Variables env <b class="ok">OK</b>`
          : `Variables env <b class="bad">manquantes</b>`;
      }
    };

    // ========= VOICE CONTROLLER =========
    const VC = (() => {
      let currentAudio = null;
      let queue = [];
      let playing = false;
      let muted = false;

      async function speak(text, lang) {
        if (muted) return;                // muet = pas de TTS
        queue.push({text, lang});
        UI.setPlay(`queue: ${queue.length}`);
        if (!playing) _dequeue();
      }

      async function _dequeue(){
        if (playing) return;
        const item = queue.shift();
        if (!item) { UI.setPlay("-"); return; }
        playing = true;
        UI.setPlay("synthèse…");

        try {
          const res = await fetch(FN('tts'), {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: item.text, lang: item.lang || 'fr' })
          });
          if (!res.ok) {
            const x = await res.text();
            console.warn("TTS error", x);
            UI.setPlay("erreur TTS");
          } else {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            if (currentAudio) { currentAudio.pause(); currentAudio.src=''; }
            currentAudio = new Audio(url);
            currentAudio.onended = () => { playing = false; URL.revokeObjectURL(url); _dequeue(); };
            currentAudio.play().catch(()=>{ playing=false; _dequeue(); });
          }
        } catch(e){
          console.error(e);
          UI.setPlay("erreur TTS");
          playing=false;
        }
      }

      function stopAll(){
        queue = [];
        if (currentAudio){ currentAudio.pause(); currentAudio.src=''; currentAudio=null; }
        playing = false;
        UI.setPlay("-");
      }
      function setMuted(v){
        muted = v; if (muted) stopAll();
      }
      return { speak, stopAll, setMuted };
    })();

    // ========= FLOW =========
    async function envCheck(){
      try {
        const r = await fetch(FN('env-check'));
        if (!r.ok){ UI.setEnv(false); return; }
        const js = await r.json().catch(()=> ({}));
        const ok = js?.ok && js?.env?.OPENAI_API_KEY && js?.env?.ELEVEN_API_KEY;
        UI.setEnv(!!ok);
        if (js?.env?.OPENAI_MODEL) llmBadge.textContent = js.env.OPENAI_MODEL;
      } catch{ UI.setEnv(false); }
    }

    async function detectLang(text){
      try{
        const r = await fetch(FN('lang-detect'),{
          method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        const js = await r.json().catch(()=> ({}));
        const lang = js?.lang || 'fr';
        UI.setLang(lang);
        return lang;
      }catch(e){
        console.warn(e);
        UI.setLang('fr');
        return 'fr';
      }
    }

    async function askLLM(userText, langHint){
      try{
        const r = await fetch(FN('chat'),{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userText, langHint })
        });
        const js = await r.json().catch(()=> ({}));
        return js?.reply || "Désolé, je n’ai pas saisi.";
      }catch(e){
        console.warn(e);
        return "Un incident temporaire s’est produit.";
      }
    }

    async function handleSend(text){
      const clean = (text||"").trim();
      if (!clean) return;
      UI.push('user', clean);
      $("#msg").value = "";
      VC.stopAll();

      UI.setStatus("Détection langue…");
      const lang = await detectLang(clean);

      UI.setStatus("Réponse IA…");
      const reply = await askLLM(clean, lang);

      UI.push('ai', reply);
      UI.setStatus("Synthèse vocale…");
      await VC.speak(reply, lang);
      UI.setStatus("Prêt");
    }

    // ========= EVENTS =========
    $("#sendBtn").addEventListener("click", ()=> handleSend($("#msg").value));
    $("#msg").addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); handleSend($("#msg").value); }
    });
    muteToggle.addEventListener("change", e => VC.setMuted(e.target.checked));

    // ========= BOOT =========
    (async function boot(){
      UI.setStatus("Initialisation…");
      await envCheck();

      // Message d’accueil (pas de chevauchement, TTS en file)
      const welcome = `Bienvenue dans la démo Ecommind. Dites-moi votre besoin : site, automatisation, ou prise de rendez-vous ?`;
      UI.push('ai', welcome);
      await VC.speak(welcome, 'fr');

      UI.setStatus("Prêt");
    })();
  </script>
</body>
</html>

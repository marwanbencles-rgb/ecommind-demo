<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ecommind Agency â€” DÃ©mo IA vocale</title>
  <meta name="description" content="DÃ©mo IA multilingue Ecommind â€” voix naturelle, scÃ©nario orientÃ© conversion.">
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* petites classes utilitaires locales */
    .highlight-gold{color:#C9A55E}
    .highlight-blue{color:#00BFFF}
    .btn{border:1px solid rgba(255,255,255,.14);background:transparent;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px);border-color:#00BFFF;box-shadow:0 0 0 4px rgba(0,191,255,.08)}
    .btn.gold{border-color:#C9A55E}
    .inp{flex:1;min-width:240px;background:transparent;border:1px solid rgba(255,255,255,.14);color:#fff;padding:12px 14px;border-radius:12px;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:10px;font-size:12px;color:#98A2B3}
    .status{font-size:12px;opacity:.85}
    .resp{white-space:pre-wrap;line-height:1.6;border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:14px;min-height:84px}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    body{background:#000;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .hero{display:grid;gap:14px;padding:24px;border:1px solid rgba(255,255,255,.08);border-radius:20px;background:#0D1B2A}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;background:#000}
    @media(max-width:880px){.grid{grid-template-columns:1fr 1fr}}
    @media(max-width:620px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="row" style="gap:12px">
        <div style="width:12px;height:12px;border-radius:50%;background:#C9A55E;box-shadow:0 0 16px #C9A55E"></div>
        <div>
          <div style="font-weight:800;letter-spacing:.3px">Ecommind Agency</div>
          <div style="opacity:.85;font-size:12px;color:#98A2B3">Captiver. DÃ©clencher. Convertir.</div>
        </div>
      </div>
      <div class="row">
        <a class="btn" href="https://ecommind-agency.com/pages/packs">Voir les packs</a>
        <a class="btn gold" href="https://ecommind-agency.com/pages/contact-ecommind">Parler Ã  un expert</a>
      </div>
    </header>

    <section class="hero" aria-label="DÃ©mo IA vocale">
      <h1 style="margin:0;font-size:28px;line-height:1.2">
        Votre assistant <span class="highlight-blue">premium</span> qui parle la langue du client
        et <span class="highlight-gold">close</span> sans friction.
      </h1>
      <p style="margin:0;opacity:.9;color:#98A2B3">DÃ©mo multilingue â€” voix naturelle, rÃ©ponses courtes, orientÃ©es dÃ©cision.</p>

      <!-- Controls -->
      <div class="row">
        <button id="recBtn" class="btn" style="border-color:rgba(201,165,94,.6)">ðŸŽ¤ Enregistrer</button>
        <button id="stopBtn" class="btn" disabled>â–  Stop</button>
        <input id="textInput" class="inp" placeholder="â€¦ou Ã©crivez une question (FR / EN / AR / ES)"/>
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>

      <div class="row">
        <div class="badge">Langue dÃ©tectÃ©e : <b id="lang">â€”</b></div>
        <div class="badge status">Statut : <span id="status">PrÃªt</span></div>
      </div>

      <div id="output" class="resp" aria-live="polite">La rÃ©ponse sâ€™affichera iciâ€¦</div>
      <audio id="player" controls style="width:100%"></audio>

      <div class="grid" aria-label="Arguments clÃ©s">
        <div class="card"><h3 style="margin:0 0 6px 0;color:#C9A55E">ClartÃ© qui rassure</h3><div style="color:#98A2B3">Messages courts, ton premium. Lâ€™IA garde le cadre et propose la suite.</div></div>
        <div class="card"><h3 style="margin:0 0 6px 0;color:#C9A55E">Langue & voix natives</h3><div style="color:#98A2B3">DÃ©tection automatique. Voix ElevenLabs adaptÃ©es Ã  chaque langue.</div></div>
        <div class="card"><h3 style="margin:0 0 6px 0;color:#C9A55E">PrÃªt Ã  closer</h3><div style="color:#98A2B3">Objection â†’ bÃ©nÃ©fice â†’ next-step. CTA discrets mais efficaces.</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0;color:#C9A55E">Offre de dÃ©ploiement</h3>
        <div style="color:#98A2B3">Mise en place <b class="highlight-gold">2490â‚¬</b> Â· Accompagnement <b class="highlight-blue">490â‚¬/mois</b> (dÃ¨s M3).</div>
        <div class="row" style="margin-top:10px">
          <a class="btn gold" href="https://ecommind-agency.com/pages/offre-royale-buisness">Pack Royal</a>
          <a class="btn" href="https://ecommind-agency.com/pages/offre-elegance">Pack Ã‰lÃ©gance</a>
          <a class="btn" href="https://ecommind-agency.com/pages/offre-buisness">Pack Business</a>
        </div>
      </div>
    </section>

    <footer style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,.12);font-size:12px;color:#98A2B3">
      <div>Â© 2025 Ecommind Agency. Tous droits rÃ©servÃ©s.</div>
      <div><a href="https://ecommind-agency.com/pages/a-propos" style="color:#00BFFF">Ã€ propos</a> Â· <a href="https://ecommind-agency.com/pages/contact-ecommind" style="color:#00BFFF">Contact</a></div>
    </footer>
  </div>

  <!-- ================== Script ================== -->
  <script type="module">
    import { VoiceController } from './voice-controller.js';

    // Elements
    const recBtn = document.getElementById("recBtn");
    const stopBtn = document.getElementById("stopBtn");
    const sendBtn = document.getElementById("sendBtn");
    const textInput = document.getElementById("textInput");
    const langEl = document.getElementById("lang");
    const statusEl = document.getElementById("status");
    const outEl = document.getElementById("output");
    const player = document.getElementById("player");

    // Helpers
    const setStatus = (t)=> statusEl.textContent = t;
    const setLang = (t)=> langEl.textContent = t || "â€”";

    // Voice controller (anti-chevauchement)
    const VC = new VoiceController({ audioEl: player, apiBase: "" });
    await VC.initVoices();

    // --- AUDIO RECORDING (Netlify: STT en base64) ---
    let mediaRecorder, chunks = [];

    recBtn.onclick = async () => {
      try {
        VC.stop(); // coupe toute voix active
        setStatus("Enregistrementâ€¦");
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = (e)=> chunks.push(e.data);
        mediaRecorder.onstop = onStopRecord;
        mediaRecorder.start();
        recBtn.disabled = true; stopBtn.disabled = false;
      } catch (e) {
        setStatus("Micro refusÃ©"); console.error(e);
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
      recBtn.disabled = false; stopBtn.disabled = true;
      setStatus("Traitementâ€¦");
    };

    async function onStopRecord(){
      // 1) Encode audio -> base64 (Netlify friendly)
      const blob = new Blob(chunks, { type: "audio/webm" });
      const ab = await blob.arrayBuffer();
      const audioBase64 = btoa(String.fromCharCode(...new Uint8Array(ab)));

      // 2) STT
      const stt = await fetch(`/api/stt`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ audioBase64 })
      }).then(r=>r.json()).catch(console.error);

      if (!stt || stt.error) { setStatus("Erreur STT"); return; }
      const userText = stt.text || "";
      const lang = (stt.language || "en").slice(0,2).toLowerCase();
      setLang(lang);

      // 3) CHAT
      setStatus("GÃ©nÃ©rationâ€¦");
      const chat = await fetch(`/api/chat`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userText, langHint: lang })
      }).then(r=>r.json()).catch(console.error);

      if (!chat || chat.error) { setStatus("Erreur LLM"); return; }
      outEl.textContent = chat.reply || "";

      // 4) TTS (anti-overlap)
      setStatus("ðŸ”Š Parole IAâ€¦");
      recBtn.disabled = true; sendBtn.disabled = true;
      await VC.speak(chat.reply || "", lang);
      recBtn.disabled = false; sendBtn.disabled = false;
      setStatus("PrÃªt");
    }

    // --- TEXT FLOW (lang detect -> chat -> tts) ---
    sendBtn.onclick = async () => {
      VC.stop(); // coupe la voix au cas oÃ¹
      const userText = (textInput.value || "").trim();
      if (!userText) return;

      setStatus("DÃ©tection de langueâ€¦");
      const det = await fetch(`/api/lang-detect`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text: userText })
      }).then(r=>r.json()).catch(console.error);

      const lang = (det?.lang || "en").slice(0,2).toLowerCase();
      setLang(lang);

      setStatus("GÃ©nÃ©rationâ€¦");
      const chat = await fetch(`/api/chat`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userText, langHint: lang })
      }).then(r=>r.json()).catch(console.error);

      if (!chat || chat.error) { setStatus("Erreur LLM"); return; }
      outEl.textContent = chat.reply || "";

      setStatus("ðŸ”Š Parole IAâ€¦");
      recBtn.disabled = true; sendBtn.disabled = true;
      await VC.speak(chat.reply || "", lang);
      recBtn.disabled = false; sendBtn.disabled = false;
      setStatus("PrÃªt");
    };

    // Lancement de bienvenue (facultatif)
    setTimeout(() => {
      VC.speak("Bienvenue dans la dÃ©mo Ecommind. Parlez, lâ€™IA sâ€™adapte Ã  votre langue et propose la suite.", "fr");
    }, 1200);
  </script>
</body>
</html>

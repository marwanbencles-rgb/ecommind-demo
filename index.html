<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ecommind â€” DÃ©mo IA Vocale</title>
  <meta name="description" content="DÃ©mo IA multilingue Ecommind â€” voix naturelle, anti-chevauchement, closing premium.">
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root { --gold:#C9A55E; --blue:#00BFFF; --bg:#000; --bg2:#0D1B2A; --text:#FFF; --muted:#98A2B3; }
    html,body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.16);background:transparent;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px);border-color:var(--blue);box-shadow:0 0 0 4px rgba(0,191,255,.08)}
    .btn.gold{border-color:var(--gold)}
    .inp{flex:1;min-width:240px;background:transparent;border:1px solid rgba(255,255,255,.16);color:#fff;padding:12px 14px;border-radius:12px;outline:none}
    .badge{border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:10px;font-size:12px;color:var(--muted)}
    .status{font-size:12px;opacity:.9}
    .hero{display:grid;gap:14px;padding:24px;border:1px solid rgba(255,255,255,.10);border-radius:20px;background:var(--bg2)}
    .resp{white-space:pre-wrap;line-height:1.6;border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:14px;min-height:84px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;background:#000}
    @media(max-width:880px){.grid{grid-template-columns:1fr 1fr}}
    @media(max-width:620px){.grid{grid-template-columns:1fr}}
    .gold{color:var(--gold)} .blue{color:var(--blue)}
    footer{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,.12);font-size:12px;color:var(--muted)}
    a.link{color:var(--blue);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="row" style="gap:12px">
        <div style="width:12px;height:12px;border-radius:50%;background:var(--gold);box-shadow:0 0 16px var(--gold)"></div>
        <div>
          <div style="font-weight:800;letter-spacing:.3px">Ecommind Agency</div>
          <div style="opacity:.85;font-size:12px;color:var(--muted)">Captiver. DÃ©clencher. Convertir.</div>
        </div>
      </div>
      <div class="row">
        <a class="btn" href="https://ecommind-agency.com/pages/packs">Voir les packs</a>
        <a class="btn gold" href="https://ecommind-agency.com/pages/contact-ecommind">Parler Ã  un expert</a>
      </div>
    </header>

    <section class="hero" aria-label="DÃ©mo IA vocale">
      <h1 style="margin:0;font-size:28px;line-height:1.2">
        Lâ€™assistant <span class="blue">multilingue</span> qui parle, comprend et <span class="gold">close</span>.
      </h1>
      <p style="margin:0;opacity:.9;color:var(--muted)">Anti-chevauchement vocal. DÃ©tection de langue. RÃ©ponses courtes orientÃ©es dÃ©cision.</p>

      <!-- Controls -->
      <div class="row">
        <button id="recBtn" class="btn" style="border-color:rgba(201,165,94,.6)">ðŸŽ¤ Enregistrer</button>
        <button id="stopBtn" class="btn" disabled>â–  Stop</button>
        <input id="textInput" class="inp" placeholder="â€¦ou Ã©crivez une question (FR / EN / AR / ES / DE / IT)"/>
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>

      <div class="row">
        <div class="badge">Langue dÃ©tectÃ©e : <b id="lang">â€”</b></div>
        <div class="badge status">Statut : <span id="status">Initialisationâ€¦</span></div>
        <div class="badge" id="envBadge" title="Ã‰tat variables serveur">Env: â€”</div>
      </div>

      <div id="output" class="resp" aria-live="polite">La rÃ©ponse sâ€™affichera iciâ€¦</div>
      <audio id="player" controls style="width:100%"></audio>

      <div class="grid" aria-label="Arguments clÃ©s">
        <div class="card"><h3 style="margin:0 0 6px 0" class="gold">ClartÃ© qui rassure</h3><div style="color:var(--muted)">Messages courts, ton premium. Lâ€™IA garde le cadre et propose la suite.</div></div>
        <div class="card"><h3 style="margin:0 0 6px 0" class="gold">Langue & voix natives</h3><div style="color:var(--muted)">DÃ©tection automatique. Voix ElevenLabs par langue. ZÃ©ro overlap.</div></div>
        <div class="card"><h3 style="margin:0 0 6px 0" class="gold">PrÃªt Ã  closer</h3><div style="color:var(--muted)">Objection â†’ bÃ©nÃ©fice â†’ next-step. CTA discrets mais efficaces.</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0" class="gold">Offre</h3>
        <div style="color:var(--muted)">Mise en place <b class="gold">2490â‚¬</b> Â· Accompagnement <b class="blue">490â‚¬/mois</b> (dÃ¨s M3).</div>
        <div class="row" style="margin-top:10px">
          <a class="btn gold" href="https://ecommind-agency.com/pages/offre-royale-buisness">Pack Royal</a>
          <a class="btn" href="https://ecommind-agency.com/pages/offre-elegance">Pack Ã‰lÃ©gance</a>
          <a class="btn" href="https://ecommind-agency.com/pages/offre-buisness">Pack Business</a>
        </div>
      </div>
    </section>

    <footer>
      <div>Â© 2025 Ecommind Agency. Tous droits rÃ©servÃ©s.</div>
      <div><a class="link" href="https://ecommind-agency.com/pages/a-propos">Ã€ propos</a> Â· <a class="link" href="https://ecommind-agency.com/pages/contact-ecommind">Contact</a></div>
    </footer>
  </div>

  <!-- ================== Script ================== -->
  <script type="module">
    import { VoiceController } from './voice-controller.js';

    // Elements
    const recBtn = document.getElementById("recBtn");
    const stopBtn = document.getElementById("stopBtn");
    const sendBtn = document.getElementById("sendBtn");
    const textInput = document.getElementById("textInput");
    const langEl = document.getElementById("lang");
    const statusEl = document.getElementById("status");
    const envBadge = document.getElementById("envBadge");
    const outEl = document.getElementById("output");
    const player = document.getElementById("player");

    // Helpers
    const setStatus = (t)=> statusEl.textContent = t;
    const setLang = (t)=> langEl.textContent = t || "â€”";

    // Voice controller (anti-chevauchement)
    const VC = new VoiceController({ audioEl: player, apiBase: "" });
    await VC.initVoices();

    // ---- VÃ©rif env serveur (OPENAI/ELEVEN) ----
    try {
      const env = await fetch('/api/env-check').then(r=>r.ok?r.json():null).catch(()=>null);
      if (env?.env?.OPENAI_API_KEY && env?.env?.ELEVEN_API_KEY) {
        envBadge.textContent = "Env: OK";
      } else if (env?.env?.OPENAI_API_KEY) {
        envBadge.textContent = "Env: OpenAI OK / Eleven ?";
      } else {
        envBadge.textContent = "Env: Ã  configurer";
      }
    } catch { envBadge.textContent = "Env: â€”"; }

    // --- AUDIO RECORDING (Netlify: STT en base64) ---
    let mediaRecorder, chunks = [];

    recBtn.onclick = async () => {
      try {
        VC.stop(); // coupe toute voix active
        setStatus("Enregistrementâ€¦");
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = (e)=> chunks.push(e.data);
        mediaRecorder.onstop = onStopRecord;
        mediaRecorder.start();
        recBtn.disabled = true; stopBtn.disabled = false;
      } catch (e) {
        setStatus("Micro refusÃ©"); console.error(e);
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
      recBtn.disabled = false; stopBtn.disabled = true;
      setStatus("Traitementâ€¦");
    };

    async function onStopRecord(){
      try {
        // 1) Encode audio -> base64 (Netlify friendly)
        const blob = new Blob(chunks, { type: "audio/webm" });
        const ab = await blob.arrayBuffer();
        const audioBase64 = btoa(String.fromCharCode(...new Uint8Array(ab)));

        // 2) STT
        const stt = await fetch(`/api/stt`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ audioBase64 })
        }).then(r=>r.json());

        if (!stt || stt.error) { setStatus("Erreur STT"); return; }
        const userText = stt.text || "";
        const lang = (stt.language || "en").slice(0,2).toLowerCase();
        setLang(lang);

        // 3) CHAT
        setStatus("GÃ©nÃ©rationâ€¦");
        const chat = await fetch(`/api/chat`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ userText, langHint: lang })
        }).then(r=>r.json());

        if (!chat || chat.error) { setStatus("Erreur LLM"); return; }
        outEl.textContent = chat.reply || "";

        // 4) TTS (anti-overlap)
        setStatus("ðŸ”Š Parole IAâ€¦");
        recBtn.disabled = true; sendBtn.disabled = true;
        await VC.speak(chat.reply || "", lang);
        recBtn.disabled = false; sendBtn.disabled = false;
        setStatus("PrÃªt");
      } catch (e) {
        console.error(e); setStatus("Erreur traitement");
      }
    }

    // --- TEXT FLOW (lang detect -> chat -> tts) ---
    sendBtn.onclick = async () => {
      VC.stop(); // coupe la voix au cas oÃ¹
      const userText = (textInput.value || "").trim();
      if (!userText) return;

      try {
        setStatus("DÃ©tection de langueâ€¦");
        const det = await fetch(`/api/lang-detect`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ text: userText })
        }).then(r=>r.json());

        const lang = (det?.lang || "en").slice(0,2).toLowerCase();
        setLang(lang);

        setStatus("GÃ©nÃ©rationâ€¦");
        const chat = await fetch(`/api/chat`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ userText, langHint: lang })
        }).then(r=>r.json());

        if (!chat || chat.error) { setStatus("Erreur LLM"); return; }
        outEl.textContent = chat.reply || "";

        setStatus("ðŸ”Š Parole IAâ€¦");
        recBtn.disabled = true; sendBtn.disabled = true;
        await VC.speak(chat.reply || "", lang);
        recBtn.disabled = false; sendBtn.disabled = false;
        setStatus("PrÃªt");
      } catch (e) {
        console.error(e); setStatus("Erreur traitement");
      }
    };

    // Lancement de bienvenue (facultatif)
    window.addEventListener('load', () => {
      setStatus("PrÃªt");
      VC.speak("Bienvenue dans la dÃ©mo Ecommind. Parlez, lâ€™IA sâ€™adapte Ã  votre langue et propose la suite.", "fr");
    });
  </script>
</body>
</html>
